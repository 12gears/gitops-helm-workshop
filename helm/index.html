<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Helm Releases | GitOps Helm Workshop</title>
    <meta name="description" content="Progressive Delivery for Kubernetes with Flux, Helm v3, Linkerd and Flagger">
    <link rel="icon" href="/favicon.png">
  <link rel="stylesheet" href="/website.css">
    
    <link rel="preload" href="/assets/css/0.styles.a0ada997.css" as="style"><link rel="preload" href="/assets/js/app.ff576fad.js" as="script"><link rel="preload" href="/assets/js/2.795534d9.js" as="script"><link rel="preload" href="/assets/js/7.d311c3f3.js" as="script"><link rel="prefetch" href="/assets/js/10.b43f2962.js"><link rel="prefetch" href="/assets/js/11.d53eb7de.js"><link rel="prefetch" href="/assets/js/3.0c89a451.js"><link rel="prefetch" href="/assets/js/4.e2e0255b.js"><link rel="prefetch" href="/assets/js/5.653dd45a.js"><link rel="prefetch" href="/assets/js/6.dda421e9.js"><link rel="prefetch" href="/assets/js/8.70f4a645.js"><link rel="prefetch" href="/assets/js/9.eab26239.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a0ada997.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">GitOps Helm Workshop</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div> <a href="https://github.com/stefanprodan/gitops-helm-workshop" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div> <a href="https://github.com/stefanprodan/gitops-helm-workshop" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">Home</a></li><li><a href="/intro/" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/intro/#what-is-gitops" class="sidebar-link">What is GitOps?</a></li><li class="sidebar-sub-header"><a href="/intro/#what-is-progressive-delivery" class="sidebar-link">What is Progressive Delivery?</a></li></ul></li><li><a href="/prerequisites/" class="sidebar-link">Prerequisites</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/prerequisites/#helm-v3" class="sidebar-link">Helm v3</a></li><li class="sidebar-sub-header"><a href="/prerequisites/#git" class="sidebar-link">Git</a></li><li class="sidebar-sub-header"><a href="/prerequisites/#flux" class="sidebar-link">Flux</a></li><li class="sidebar-sub-header"><a href="/prerequisites/#helm-operator" class="sidebar-link">Helm Operator</a></li><li class="sidebar-sub-header"><a href="/prerequisites/#linkerd" class="sidebar-link">Linkerd</a></li><li class="sidebar-sub-header"><a href="/prerequisites/#flagger" class="sidebar-link">Flagger</a></li></ul></li><li><a href="/helm/" class="active sidebar-link">Helm Releases</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/helm/#install-nginx" class="sidebar-link">Install NGINX</a></li><li class="sidebar-sub-header"><a href="/helm/#install-podinfo" class="sidebar-link">Install podinfo</a></li><li class="sidebar-sub-header"><a href="/helm/#automated-upgrade" class="sidebar-link">Automated upgrade</a></li><li class="sidebar-sub-header"><a href="/helm/#sealed-secrets" class="sidebar-link">Sealed secrets</a></li></ul></li><li><a href="/canary/" class="sidebar-link">Canary Releases</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/canary/#application-bootstrap" class="sidebar-link">Application bootstrap</a></li><li class="sidebar-sub-header"><a href="/canary/#automated-canary-promotion" class="sidebar-link">Automated canary promotion</a></li><li class="sidebar-sub-header"><a href="/canary/#automated-rollback" class="sidebar-link">Automated rollback</a></li><li class="sidebar-sub-header"><a href="/canary/#monitoring-with-linkerd" class="sidebar-link">Monitoring with Linkerd</a></li></ul></li><li><a href="/test/" class="sidebar-link">Canary Helm Tests</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/test/#create-tests" class="sidebar-link">Create tests</a></li><li class="sidebar-sub-header"><a href="/test/#run-tests" class="sidebar-link">Run tests</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="helm-releases"><a href="#helm-releases" aria-hidden="true" class="header-anchor">#</a> Helm Releases</h1> <p>A chart release is described through a Kubernetes custom resource named <strong>HelmRelease</strong>.</p> <p>A Helm release can refer a chart from:</p> <ul><li>public or private Helm repositories over HTTPS</li> <li>public or private Git repositories over SSH</li></ul> <h2 id="install-nginx"><a href="#install-nginx" aria-hidden="true" class="header-anchor">#</a> Install NGINX</h2> <p>To expose applications outside of the cluster you'll be using the NGINX ingress controller.
The controller will run inside the Linkerd mesh.</p> <p>Create a namespace with linkerd injection enabled:</p> <div class="language-yaml extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">fluxcd.io/ignore</span><span class="token punctuation">:</span> <span class="token string">&quot;false&quot;</span>
    <span class="token key atrule">linkerd.io/inject</span><span class="token punctuation">:</span> enabled
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
</code></pre></div><p>Create a Helm release to install the NGINX ingress controller:</p> <div class="language-yaml extra-class"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> helm.fluxcd.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HelmRelease
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">fluxcd.io/ignore</span><span class="token punctuation">:</span> <span class="token string">&quot;false&quot;</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">releaseName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress
  <span class="token key atrule">chart</span><span class="token punctuation">:</span>
    <span class="token key atrule">repository</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//kubernetes<span class="token punctuation">-</span>charts.storage.googleapis.com/
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress
    <span class="token key atrule">version</span><span class="token punctuation">:</span> 1.33.4
  <span class="token key atrule">values</span><span class="token punctuation">:</span>
    <span class="token key atrule">controller</span><span class="token punctuation">:</span>
      <span class="token key atrule">service</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> LoadBalancer
</code></pre></div><p>Apply changes:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">git</span> <span class="token function">add</span> -A <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
<span class="token function">git</span> commit -m <span class="token string">&quot;install ingress&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
<span class="token function">git</span> push origin master <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
fluxctl <span class="token function">sync</span>
</code></pre></div><p>Validate that the Helm operator has installed the release:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl -n ingress-nginx get hr
</code></pre></div><p>Find the public IP of the ingress controller:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl -n ingress-nginx get svc
</code></pre></div><h2 id="install-podinfo"><a href="#install-podinfo" aria-hidden="true" class="header-anchor">#</a> Install podinfo</h2> <p><a href="http://github.com/stefanprodan/podinfo" target="_blank" rel="noopener noreferrer">Podinfo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is tiny Go web application.
You'll be installing podinfo using a Helm chart stored in the git repository at <code>cluster/charts/podinfo</code>.</p> <p>Create the <code>prod</code> namespace with linkerd injection enabled:</p> <div class="language-yaml extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">fluxcd.io/ignore</span><span class="token punctuation">:</span> <span class="token string">&quot;false&quot;</span>
    <span class="token key atrule">linkerd.io/inject</span><span class="token punctuation">:</span> enabled
  <span class="token key atrule">name</span><span class="token punctuation">:</span> prod
</code></pre></div><p>Create a Helm release to install the podinfo chart
(replace <code>GHUSER</code> with your GitHub username and <code>LB-PUBLIC-IP</code> with your ingress IP):</p> <div class="language-yaml extra-class"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br></div><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> helm.fluxcd.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HelmRelease
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> podinfo
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> prod
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">fluxcd.io/ignore</span><span class="token punctuation">:</span> <span class="token string">&quot;false&quot;</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">releaseName</span><span class="token punctuation">:</span> podinfo
  <span class="token key atrule">chart</span><span class="token punctuation">:</span>
    <span class="token key atrule">git</span><span class="token punctuation">:</span> git@github.com<span class="token punctuation">:</span>GHUSER/gitops<span class="token punctuation">-</span>helm<span class="token punctuation">-</span>workshop
    <span class="token key atrule">ref</span><span class="token punctuation">:</span> master
    <span class="token key atrule">path</span><span class="token punctuation">:</span> cluster/charts/podinfo
  <span class="token key atrule">values</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span>
      <span class="token key atrule">repository</span><span class="token punctuation">:</span> stefanprodan/podinfo
      <span class="token key atrule">tag</span><span class="token punctuation">:</span> 3.1.0
    <span class="token key atrule">service</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
    <span class="token key atrule">ingress</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
        <span class="token key atrule">kubernetes.io/ingress.class</span><span class="token punctuation">:</span> <span class="token string">&quot;nginx&quot;</span>
        <span class="token key atrule">nginx.ingress.kubernetes.io/configuration-snippet</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          proxy_set_header l5d-dst-override $service_name.$namespace.svc.cluster.local:9898;
          proxy_hide_header l5d-remote-ip;
          proxy_hide_header l5d-server-id;</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /
      <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> LB<span class="token punctuation">-</span>PUBLIC<span class="token punctuation">-</span>IP.nip.io
</code></pre></div><p>Note that if you are on EKS, the host should be set to the <code>elb.amazonaws.com</code> address:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl -n ingress-nginx get svc <span class="token operator">|</span> <span class="token function">grep</span> Ingress
</code></pre></div><p>Apply changes:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">git</span> <span class="token function">add</span> -A <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
<span class="token function">git</span> commit -m <span class="token string">&quot;install podinfo&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
<span class="token function">git</span> push origin master <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
fluxctl <span class="token function">sync</span>
</code></pre></div><p>Validate that the Helm operator has installed podinfo:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl -n prod get hr
</code></pre></div><p>Open your browser and navigate to <code>http://LB-PUBLIC-IP.nip.io/</code>, you should see podinfo v3.1.0 UI.</p> <h2 id="automated-upgrade"><a href="#automated-upgrade" aria-hidden="true" class="header-anchor">#</a> Automated upgrade</h2> <p>Flux can be used to automate container image updates in your cluster.
You can enable the automate image tag updates by annotating Helm release objects.
You can also control what tags should be considered for an
update by using glob, regex or semantic version expressions.</p> <p>Edit the podinfo Helm release and enable Flux automated image updates:</p> <div class="language-yaml extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br></div><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> helm.fluxcd.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HelmRelease
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">fluxcd.io/automated</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
    <span class="token key atrule">fluxcd.io/tag.chart-image</span><span class="token punctuation">:</span> semver<span class="token punctuation">:</span>~3.1
</code></pre></div><p>Apply changes:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">git</span> <span class="token function">add</span> -A <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
<span class="token function">git</span> commit -m <span class="token string">&quot;automate podinfo&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
<span class="token function">git</span> push origin master <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
fluxctl <span class="token function">sync</span>
</code></pre></div><p>Validate that the Helm operator has upgraded podinfo:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl -n prod get hr
</code></pre></div><p>Pull the changes made by Flux locally:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">git</span> pull origin master
</code></pre></div><p>Open your browser and navigate to <code>http://LB-PUBLIC-IP.nip.io/</code>, you should see podinfo v3.1.5 UI.</p> <h2 id="sealed-secrets"><a href="#sealed-secrets" aria-hidden="true" class="header-anchor">#</a> Sealed secrets</h2> <p>In order to store secrets safely in a public Git repo you can use the
<a href="https://github.com/bitnami-labs/sealed-secrets" target="_blank" rel="noopener noreferrer">Sealed Secrets controller<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
and encrypt your Kubernetes Secrets into <strong>SealedSecrets</strong>.
The sealed secret can be decrypted only by the controller running in your cluster.</p> <p>Create the Sealed Secrets Helm release:</p> <div class="language-yaml extra-class"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> helm.fluxcd.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HelmRelease
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> sealed<span class="token punctuation">-</span>secrets
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> fluxcd
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">fluxcd.io/ignore</span><span class="token punctuation">:</span> <span class="token string">&quot;false&quot;</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">releaseName</span><span class="token punctuation">:</span> sealed<span class="token punctuation">-</span>secrets
  <span class="token key atrule">chart</span><span class="token punctuation">:</span>
    <span class="token key atrule">repository</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//kubernetes<span class="token punctuation">-</span>charts.storage.googleapis.com/
    <span class="token key atrule">name</span><span class="token punctuation">:</span> sealed<span class="token punctuation">-</span>secrets
    <span class="token key atrule">version</span><span class="token punctuation">:</span> 1.8.0
</code></pre></div><p>Apply changes:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">git</span> <span class="token function">add</span> -A <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
<span class="token function">git</span> commit -m <span class="token string">&quot;install sealed-secrets&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
<span class="token function">git</span> push origin master <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
fluxctl <span class="token function">sync</span>
</code></pre></div><p>Install the kubeseal CLI:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">wget</span> https://github.com/bitnami-labs/sealed-secrets/releases/download/v1.8.0/kubeseal-darwin-amd64
<span class="token function">sudo</span> <span class="token function">install</span> -m <span class="token number">755</span> kubeseal-darwin-amd64 /usr/local/bin/kubeseal
</code></pre></div><p>At startup, the sealed-secrets controller generates a RSA key and logs the public key.
Using kubeseal you can save your public key as pub-cert.pem,
the public key can be safely stored in Git, and can be used to encrypt secrets
without direct access to the Kubernetes cluster:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubeseal --fetch-cert <span class="token punctuation">\</span>
--controller-namespace<span class="token operator">=</span>fluxcd <span class="token punctuation">\</span>
--controller-name<span class="token operator">=</span>sealed-secrets <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> pub-cert.pem
</code></pre></div><p>You can generate a Kubernetes secret locally with kubectl and encrypt it with kubeseal:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl -n prod create secret generic basic-auth <span class="token punctuation">\</span>
--from-literal<span class="token operator">=</span>user<span class="token operator">=</span>admin <span class="token punctuation">\</span>
--from-literal<span class="token operator">=</span>password<span class="token operator">=</span>admin <span class="token punctuation">\</span>
--dry-run <span class="token punctuation">\</span>
-o json <span class="token operator">&gt;</span> basic-auth.json

kubeseal --format<span class="token operator">=</span>yaml --cert<span class="token operator">=</span>pub-cert.pem <span class="token operator">&lt;</span> basic-auth.json <span class="token operator">&gt;</span> basic-auth.yaml
</code></pre></div><p>This generates a custom resource of type SealedSecret that contains the encrypted credentials.</p> <p>Flux will apply the sealed secret on your cluster and sealed-secrets controller will
then decrypt it into a Kubernetes secret.</p> <p>To prepare for disaster recovery you should backup the Sealed Secrets controller private key with:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl get secret -n fluxcd sealed-secrets-key -o yaml <span class="token punctuation">\</span>
--export <span class="token operator">&gt;</span> sealed-secrets-key.yaml
</code></pre></div><p>To restore from backup after a disaster, replace the newly-created secret and restart the controller:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl replace secret -n fluxcd sealed-secrets-key -f sealed-secrets-key.yaml
kubectl delete pod -n fluxcd -l <span class="token assign-left variable">app</span><span class="token operator">=</span>sealed-secrets
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/prerequisites/" class="prev">
          Prerequisites
        </a></span> <span class="next"><a href="/canary/">
          Canary Releases
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ff576fad.js" defer></script><script src="/assets/js/2.795534d9.js" defer></script><script src="/assets/js/7.d311c3f3.js" defer></script>
  </body>
</html>
